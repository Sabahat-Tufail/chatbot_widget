class r {
  constructor({ apiUrl: t, apiKey: e, sessionId: i }) {
    this.apiUrl = t, this.apiKey = e, this.sessionId = i, this.conversation = JSON.parse(localStorage.getItem("chatHistory") || "[]"), this.init();
  }
  // Initialize widget
  init() {
    this.injectCSS(), this.createElements(), this.addEventListeners(), this.renderChat();
  }
  // Inject CSS dynamically
  injectCSS() {
    const t = document.createElement("style");
    t.textContent = `
      #chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 9999; font-family: sans-serif; }
      #chat-widget-toggle { width: 50px; height: 50px; border-radius: 50%; cursor: pointer; background: #007bff; color: white; font-size: 24px; border: none; }
      #chat-widget-box { display: none; width: 320px; height: 400px; position: absolute; bottom: 60px; right: 0; border: 1px solid #ccc; background: white; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; }
      #chat-box { flex: 1; overflow-y: auto; padding: 5px; display: flex; flex-direction: column; }
      .message.user { background: #007bff; color: white; margin: 5px 0; padding: 5px 10px; border-radius: 5px; align-self: flex-end; max-width: 80%; word-wrap: break-word; }
      .message.assistant { background: #e5e5e5; color: black; margin: 5px 0; padding: 5px 10px; border-radius: 5px; align-self: flex-start; max-width: 80%; word-wrap: break-word; }
      #chat-widget-form { display: flex; border-top: 1px solid #ccc; }
      #chat-widget-input { flex: 1; border: none; padding: 10px; outline: none; }
      #chat-widget-send { border: none; background: #007bff; color: white; padding: 0 15px; cursor: pointer; }
    `, document.head.appendChild(t);
  }
  // Create chat elements
  createElements() {
    this.widget = document.createElement("div"), this.widget.id = "chat-widget", this.widget.innerHTML = `
      <button id="chat-widget-toggle">ðŸ’¬</button>
      <div id="chat-widget-box">
        <div id="chat-box"></div>
        <form id="chat-widget-form">
          <input id="chat-widget-input" placeholder="Type a message..." autocomplete="off" />
          <button type="submit" id="chat-widget-send">Send</button>
        </form>
      </div>
    `, document.body.appendChild(this.widget), this.toggleBtn = document.getElementById("chat-widget-toggle"), this.chatWindow = document.getElementById("chat-widget-box"), this.chatBox = document.getElementById("chat-box"), this.chatForm = document.getElementById("chat-widget-form"), this.chatInput = document.getElementById("chat-widget-input");
  }
  // Add event listeners
  addEventListeners() {
    this.toggleBtn.addEventListener("click", () => {
      this.chatWindow.style.display = this.chatWindow.style.display === "flex" ? "none" : "flex";
    }), this.chatForm.addEventListener("submit", (t) => this.sendMessage(t));
  }
  // Render conversation
  renderChat() {
    this.chatBox.innerHTML = "", this.conversation.forEach((t) => {
      const e = document.createElement("div");
      e.classList.add("message", t.role), e.textContent = t.content, this.chatBox.appendChild(e);
    }), this.chatBox.scrollTop = this.chatBox.scrollHeight;
  }
  // Save conversation to localStorage
  saveChat() {
    localStorage.setItem("chatHistory", JSON.stringify(this.conversation));
  }
  // Send message to backend
  async sendMessage(t) {
    t.preventDefault();
    const e = this.chatInput.value.trim();
    if (!e) return;
    this.conversation.push({ role: "user", content: e }), this.saveChat(), this.renderChat(), this.chatInput.value = "";
    const i = document.createElement("div");
    i.classList.add("message", "assistant"), i.textContent = "", this.chatBox.appendChild(i);
    try {
      const o = await fetch(this.apiUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-session-id": this.sessionId,
          "x-api-key": this.apiKey
        },
        body: JSON.stringify({ conversation: this.conversation })
      });
      if (!o.ok) {
        i.textContent = `[Error: ${o.status}]`;
        return;
      }
      const c = o.body.getReader(), h = new TextDecoder();
      let s = "";
      for (; ;) {
        const { value: l, done: p } = await c.read();
        if (p) break;
        const g = h.decode(l, { stream: !0 }).split(`
`).filter(
          (n) => n.startsWith("data: ")
        );
        for (const n of g) {
          const a = n.replace("data: ", "").trim();
          if (a !== "[DONE]")
            try {
              const d = JSON.parse(a).content || "";
              d && (s += d, i.textContent = s, this.chatBox.scrollTop = this.chatBox.scrollHeight);
            } catch {
            }
        }
      }
      this.conversation.push({ role: "assistant", content: s }), this.saveChat(), this.renderChat();
    } catch (o) {
      console.error("Network error:", o), i.textContent = "[Network error]";
    }
  }
}
window.ChatWidget = r;
new r({
  apiUrl: "https://sabahat-demo.aidemo.buzz/chat/stream",
  apiKey: "123abcXYZ,./",
  sessionId: "test-session-123"
});
