class u {
  constructor({ apiKey: e, sessionId: t, url: a }) {
    this.apiKey = e, this.sessionId = t, this.url = a, this.conversation = [], this.initWidget();
  }
  initWidget() {
    const e = document.createElement("style");
    e.textContent = `
        .chat-widget-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: Arial, sans-serif;
            z-index: 9999;
        }
        .chat-widget-header {
            background: #007bff;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        .chat-widget-box {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #fafafa;
        }
        .chat-widget-message {
            padding: 6px 10px;
            margin-bottom: 6px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-widget-user { background: #d1e7ff; margin-left: auto; }
        .chat-widget-assistant { background: #e9ecef; }
        .chat-widget-form {
            display: flex;
            border-top: 1px solid #ccc;
        }
        .chat-widget-form input {
            flex: 1;
            padding: 8px;
            border: none;
            outline: none;
        }
        .chat-widget-form button {
            background: #007bff;
            border: none;
            color: white;
            padding: 0 16px;
            cursor: pointer;
        }
        .chat-widget-form button:hover { background: #0056b3; }
        .chat-widget-clear {
            background: #dc3545;
            color: white;
            padding: 8px;
            border: none;
            cursor: pointer;
            text-align: center;
        }
        .chat-widget-clear:hover { background: #b02a37; }
        `, document.head.appendChild(e), this.container = document.createElement("div"), this.container.className = "chat-widget-container", this.container.innerHTML = `
            <div class="chat-widget-header">Chatbot</div>
            <div class="chat-widget-box" id="chat-widget-box"></div>
            <form class="chat-widget-form" id="chat-widget-form">
                <input id="chat-widget-input" placeholder="Type your message..." />
                <button type="submit">Send</button>
            </form>
            <button class="chat-widget-clear" id="chat-widget-clear">New Chat</button>
        `, document.body.appendChild(this.container), this.chatBox = this.container.querySelector("#chat-widget-box"), this.chatInput = this.container.querySelector("#chat-widget-input"), this.chatForm = this.container.querySelector("#chat-widget-form"), this.clearBtn = this.container.querySelector("#chat-widget-clear"), this.chatForm.addEventListener("submit", (t) => this.sendMessage(t)), this.clearBtn.addEventListener("click", () => this.clearChat()), this.renderChat();
  }
  renderChat() {
    this.chatBox.innerHTML = "", this.conversation.forEach((e) => {
      const t = document.createElement("div");
      t.className = `chat-widget-message ${e.role === "user" ? "chat-widget-user" : "chat-widget-assistant"}`, t.textContent = e.content, this.chatBox.appendChild(t);
    }), this.chatBox.scrollTop = this.chatBox.scrollHeight;
  }
  saveChat() {
    localStorage.setItem("chatWidgetHistory", JSON.stringify(this.conversation));
  }
  async sendMessage(e) {
    e.preventDefault();
    const t = this.chatInput.value.trim();
    if (!t) return;
    this.conversation.push({ role: "user", content: t }), this.chatInput.value = "", this.renderChat();
    const a = document.createElement("div");
    a.className = "chat-widget-message chat-widget-assistant", a.textContent = "", this.chatBox.appendChild(a);
    try {
      const i = await fetch(this.url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-session-id": this.sessionId,
          "x-api-key": this.apiKey
        },
        body: JSON.stringify({ conversation: this.conversation })
      });
      if (!i.ok) {
        a.textContent = `[Error: ${i.status}]`;
        return;
      }
      const c = i.body.getReader(), d = new TextDecoder();
      let o = "";
      for (; ; ) {
        const { value: h, done: l } = await c.read();
        if (l) break;
        const g = d.decode(h, { stream: !0 }).split(`
`).filter((n) => n.startsWith("data: "));
        for (const n of g) {
          const r = n.replace("data: ", "").trim();
          if (r !== "[DONE]")
            try {
              const s = JSON.parse(r).content || "";
              s && (o += s, a.textContent = o, this.chatBox.scrollTop = this.chatBox.scrollHeight);
            } catch {
            }
        }
      }
      this.conversation.push({ role: "assistant", content: o }), this.renderChat(), this.saveChat();
    } catch (i) {
      console.error(i), a.textContent = "[Network error]";
    }
  }
  clearChat() {
    confirm("Are you sure you want to clear chat?") && (this.conversation = [], localStorage.removeItem("chatWidgetHistory"), this.renderChat());
  }
}
window.ChatWidget = u;
