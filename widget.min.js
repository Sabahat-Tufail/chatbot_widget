class ChatWidget {
  constructor(options = {}) {
    this.backendUrl = options.backendUrl || "http://127.0.0.1:8000";
    this.init();
  }

  init() {
    // 1. Inject CSS
    const style = document.createElement("style");
    style.textContent = `
      #chat-widget {
        position: fixed;
        bottom: 90px;
        right: 30px;
        width: 320px;
        height: 420px;
        border-radius: 15px;
        background: white;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        display: none;
        flex-direction: column;
        overflow: hidden;
        font-family: Arial, sans-serif;
        z-index: 9999;
      }
      #chat-widget .chat-header {
        background: #ff7b00;
        color: white;
        padding: 12px;
        text-align: center;
        font-weight: bold;
      }
      #chat-widget .chat-body {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
      }
      #chat-widget .chat-input {
        display: flex;
        border-top: 1px solid #ddd;
      }
      #chat-widget input {
        flex: 1;
        border: none;
        padding: 10px;
      }
      #chat-widget button {
        background: #ff7b00;
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
      }
      #chat-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #ff7b00;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        z-index: 10000;
      }
    `;
    document.head.appendChild(style);

    // 2. Create widget and toggle button
    const toggle = document.createElement("button");
    toggle.id = "chat-toggle";
    toggle.textContent = "ðŸ’¬";
    document.body.appendChild(toggle);

    const widget = document.createElement("div");
    widget.id = "chat-widget";
    widget.innerHTML = `
      <div class="chat-header">MIPS Chatbot</div>
      <div class="chat-body" id="chat-body"></div>
      <div class="chat-input">
        <input type="text" id="user-input" placeholder="Type a message..." />
        <button id="send-btn">Send</button>
      </div>`;
    document.body.appendChild(widget);

    // 3. Toggle open/close
    toggle.addEventListener("click", () => {
      widget.style.display =
        widget.style.display === "flex" ? "none" : "flex";
    });

    // 4. Send message handler
    const input = widget.querySelector("#user-input");
    const sendBtn = widget.querySelector("#send-btn");
    const chatBody = widget.querySelector("#chat-body");

    const sendMessage = async () => {
      const msg = input.value.trim();
      if (!msg) return;
      this.addMessage("You", msg, chatBody);
      input.value = "";

      try {
        const res = await fetch(`${this.backendUrl}/chat/stream`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: msg }),
        });
        const data = await res.json();
        this.addMessage("Bot", data.response || "No response", chatBody);
      } catch (err) {
        this.addMessage("Error", "Could not connect to backend", chatBody);
      }
    };

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });
  }

  addMessage(sender, text, container) {
    const div = document.createElement("div");
    div.style.margin = "8px 0";
    div.innerHTML = `<b>${sender}:</b> ${text}`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }
}

// Initialize automatically
window.addEventListener("DOMContentLoaded", () => {
  const backendUrl =
    document.currentScript.getAttribute("data-backend") ||
    "http://127.0.0.1:8000";
  new ChatWidget({ backendUrl });
});
